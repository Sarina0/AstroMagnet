{"ast":null,"code":"import _asyncToGenerator from\"@babel/runtime/helpers/asyncToGenerator\";import firestore from\"@react-native-firebase/firestore\";export function sendMessage(_x,_x2){return _sendMessage.apply(this,arguments);}function _sendMessage(){_sendMessage=_asyncToGenerator(function*(message,onError){var chatRoomId=message.chatRoomId;var chatRoomRef=firestore().collection(\"chatRooms\").doc(chatRoomId);var messageRef=chatRoomRef.collection(\"messages\").doc();var batch=firestore().batch();batch.set(messageRef,message);batch.update(chatRoomRef,{lastMessage:message});yield batch.commit().catch(function(error){console.log(\"[ERROR] error sending message\",error);onError&&onError(\"Error sending your message, please try again later\");});});return _sendMessage.apply(this,arguments);}export function createRoom(_x3,_x4,_x5){return _createRoom.apply(this,arguments);}function _createRoom(){_createRoom=_asyncToGenerator(function*(currentUsers,friends,onError){var chatUser1={id:currentUsers.id,name:currentUsers.name,profilePicture:currentUsers.profilePicture,email:currentUsers.email};var chatUser2={id:friends.id,name:friends.name,profilePicture:friends.profilePicture,email:friends.email};var chatRoomRef=firestore().collection(\"chatRooms\").doc();var chatRoomId=chatRoomRef.id;var batch=firestore().batch();var newWelComeMessage={chatRoomId:chatRoomId,sendBy:chatUser1,content:\"Welcome to the chatroom\",timestamp:new Date(),createdAt:firestore.Timestamp.now(),seen:false};batch.set(chatRoomRef,{users:[chatUser1,chatUser2],lastMessage:newWelComeMessage});var messageRef=chatRoomRef.collection(\"messages\").doc();batch.set(messageRef,newWelComeMessage);batch.update(firestore().collection(\"users\").doc(currentUsers.id),{liked:firestore.FieldValue.arrayRemove(friends.id),messagingFriendList:firestore.FieldValue.arrayUnion({email:friends.email,name:friends.name,profilePicture:friends.profilePicture,id:friends.id,chatRoomId:chatRoomId})});batch.update(firestore().collection(\"users\").doc(friends.id),{liked:firestore.FieldValue.arrayRemove(currentUsers.id),messagingFriendList:firestore.FieldValue.arrayUnion({email:currentUsers.email,name:currentUsers.name,profilePicture:currentUsers.profilePicture,id:currentUsers.id,chatRoomId:chatRoomId})});yield batch.commit().catch(function(error){console.log(\"[ERROR] error creating chatroom\",error);onError&&onError(\"Error creating chatroom, please try again later\");});return chatRoomId;});return _createRoom.apply(this,arguments);}","map":{"version":3,"names":["firestore","sendMessage","message","onError","chatRoomId","chatRoomRef","collection","doc","messageRef","batch","set","update","lastMessage","commit","catch","error","console","log","createRoom","currentUsers","friends","chatUser1","id","name","profilePicture","email","chatUser2","newWelComeMessage","sendBy","content","timestamp","Date","createdAt","Timestamp","now","seen","users","liked","FieldValue","arrayRemove","messagingFriendList","arrayUnion"],"sources":["/Users/sonminhnguyen/Documents/programming/react-native/school/astro_magnet_initial/astro_magnet/src/controller/message.ts"],"sourcesContent":["import firestore from \"@react-native-firebase/firestore\";\nimport type { Message, ChatUser } from \"@app/shared/interfaces/message\";\nimport { User } from \"@app/shared/interfaces/user\";\n\nexport async function sendMessage(\n    message: Message,\n    onError?: (error: string) => void\n    ) {\n    const { chatRoomId } = message;\n    const chatRoomRef = firestore().collection(\"chatRooms\").doc(chatRoomId);\n    const messageRef = chatRoomRef.collection(\"messages\").doc();\n    const batch = firestore().batch();\n    batch.set(messageRef, message);\n    batch.update(chatRoomRef, {\n        lastMessage: message\n    });\n    await batch\n        .commit()\n        .catch((error)=>{\n            console.log(\"[ERROR] error sending message\",error);\n            onError && onError(\"Error sending your message, please try again later\");\n        });\n}\n\nexport async function createRoom(\n    currentUsers: User,\n    friends: User,\n    onError?: (error: string) => void\n    ) {\n    const chatUser1 = {\n        id: currentUsers.id,\n        name: currentUsers.name,\n        profilePicture: currentUsers.profilePicture,\n        email: currentUsers.email,\n    }\n    const chatUser2 = {\n        id: friends.id,\n        name: friends.name,\n        profilePicture: friends.profilePicture,\n        email: friends.email,\n    }\n\n    //generate chatroom id\n    const chatRoomRef = firestore().collection(\"chatRooms\").doc();\n    const chatRoomId = chatRoomRef.id;\n\n    //create firestore batch to update multiple documents\n    const batch = firestore().batch();\n\n    const newWelComeMessage = {\n        chatRoomId,\n        sendBy: chatUser1,\n        content: \"Welcome to the chatroom\",\n        timestamp: new Date(),\n        createdAt: firestore.Timestamp.now(),\n        seen: false,\n    }\n\n    //create new chat room\n    batch.set(chatRoomRef, {\n        users: [chatUser1, chatUser2],\n        lastMessage: newWelComeMessage\n    });\n\n    //add new message to chatroom\n    const messageRef = chatRoomRef.collection(\"messages\").doc();\n    batch.set(messageRef, newWelComeMessage);\n\n    //add new chat room to current user chatrooms\n    batch.update(firestore().collection(\"users\").doc(currentUsers.id), {\n        liked: firestore.FieldValue.arrayRemove(friends.id),\n        messagingFriendList: firestore.FieldValue.arrayUnion({\n            email: friends.email,\n            name: friends.name,\n            profilePicture: friends.profilePicture,\n            id: friends.id,\n            chatRoomId: chatRoomId,\n        })\n    });\n\n    //add new chat room to friend user chatrooms\n    batch.update(firestore().collection(\"users\").doc(friends.id), {\n        liked: firestore.FieldValue.arrayRemove(currentUsers.id),\n        messagingFriendList: firestore.FieldValue.arrayUnion({\n            email: currentUsers.email,\n            name: currentUsers.name,\n            profilePicture: currentUsers.profilePicture,\n            id: currentUsers.id,\n            chatRoomId: chatRoomId,\n        })\n    });\n    await batch.commit()\n        .catch((error)=>{\n            console.log(\"[ERROR] error creating chatroom\",error);\n            onError && onError(\"Error creating chatroom, please try again later\");\n        });\n    return chatRoomId;\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}