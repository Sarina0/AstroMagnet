{"ast":null,"code":"import _asyncToGenerator from\"@babel/runtime/helpers/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/classCallCheck\";import _createClass from\"@babel/runtime/helpers/createClass\";import NativeError from'@react-native-firebase/app/lib/internal/NativeFirebaseError';import FirestoreTransaction from\"./FirestoreTransaction\";var transactionId=0;var generateTransactionId=function generateTransactionId(){return transactionId++;};var FirestoreTransactionHandler=function(){function FirestoreTransactionHandler(firestore){_classCallCheck(this,FirestoreTransactionHandler);this._firestore=firestore;this._pending={};this._firestore.emitter.addListener(this._firestore.eventNameForApp('firestore_transaction_event'),this._onTransactionEvent.bind(this));}_createClass(FirestoreTransactionHandler,[{key:\"_onTransactionEvent\",value:function _onTransactionEvent(event){switch(event.body.type){case'update':this._handleUpdate(event);break;case'error':this._handleError(event);break;case'complete':this._handleComplete(event);break;}}},{key:\"_handleUpdate\",value:function(){var _handleUpdate2=_asyncToGenerator(function*(event){var id=event.listenerId;if(!this._pending[id]){return this._remove(id);}var _this$_pending$id=this._pending[id],meta=_this$_pending$id.meta,transaction=_this$_pending$id.transaction;var updateFunction=meta.updateFunction,reject=meta.reject;transaction._prepare();var finalError;var updateFailed;var pendingResult;try{var possiblePromise=updateFunction(transaction);if(!possiblePromise||!possiblePromise.then){throw new Error(\"firebase.firestore().runTransaction(*) 'updateFunction' must return a Promise.\");}pendingResult=yield possiblePromise;}catch(exception){updateFailed=true;finalError=exception;}if(updateFailed||finalError){return reject(finalError);}transaction._pendingResult=pendingResult;return this._firestore.native.transactionApplyBuffer(id,transaction._commandBuffer);});function _handleUpdate(_x){return _handleUpdate2.apply(this,arguments);}return _handleUpdate;}()},{key:\"_handleError\",value:function _handleError(event){var id=event.listenerId,body=event.body;var error=body.error;if(!this._pending[id]){return;}var meta=this._pending[id].meta;if(meta&&error){var errorAndStack=NativeError.fromEvent(error,'firestore',meta.stack);meta.reject(errorAndStack);}}},{key:\"_handleComplete\",value:function _handleComplete(event){var id=event.listenerId;if(!this._pending[id]){return;}var _this$_pending$id2=this._pending[id],meta=_this$_pending$id2.meta,transaction=_this$_pending$id2.transaction;if(meta){meta.resolve(transaction._pendingResult);}}},{key:\"_add\",value:function _add(updateFunction){var _this=this;var id=generateTransactionId();var meta={id:id,updateFunction:updateFunction,stack:new Error().stack.split('\\n').slice(2).join('\\n')};this._pending[id]={meta:meta,transaction:new FirestoreTransaction(this._firestore,meta)};return new Promise(function(resolve,reject){_this._firestore.native.transactionBegin(id);meta.resolve=function(result){_this._remove(id);resolve(result);};meta.reject=function(error){_this._remove(id);reject(error);};});}},{key:\"_remove\",value:function _remove(id){this._firestore.native.transactionDispose(id);delete this._pending[id];}}]);return FirestoreTransactionHandler;}();export{FirestoreTransactionHandler as default};","map":{"version":3,"names":["NativeError","FirestoreTransaction","transactionId","generateTransactionId","FirestoreTransactionHandler","firestore","_firestore","_pending","emitter","addListener","eventNameForApp","_onTransactionEvent","bind","event","body","type","_handleUpdate","_handleError","_handleComplete","id","listenerId","_remove","meta","transaction","updateFunction","reject","_prepare","finalError","updateFailed","pendingResult","possiblePromise","then","Error","exception","_pendingResult","native","transactionApplyBuffer","_commandBuffer","error","errorAndStack","fromEvent","stack","resolve","split","slice","join","Promise","transactionBegin","result","transactionDispose"],"sources":["/Users/sonminhnguyen/Documents/programming/react-native/school/astro_magnet_initial/astro_magnet/node_modules/@react-native-firebase/firestore/lib/FirestoreTransactionHandler.js"],"sourcesContent":["/*\n * Copyright (c) 2016-present Invertase Limited & Contributors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this library except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nimport NativeError from '@react-native-firebase/app/lib/internal/NativeFirebaseError';\nimport FirestoreTransaction from './FirestoreTransaction';\n\nlet transactionId = 0;\n\n/**\n * Uses the push id generator to create a transaction id\n * @returns {number}\n * @private\n */\nconst generateTransactionId = () => transactionId++;\n\nexport default class FirestoreTransactionHandler {\n  constructor(firestore) {\n    this._firestore = firestore;\n    this._pending = {};\n    this._firestore.emitter.addListener(\n      this._firestore.eventNameForApp('firestore_transaction_event'),\n      this._onTransactionEvent.bind(this),\n    );\n  }\n\n  _onTransactionEvent(event) {\n    switch (event.body.type) {\n      case 'update':\n        this._handleUpdate(event);\n        break;\n      case 'error':\n        this._handleError(event);\n        break;\n      case 'complete':\n        this._handleComplete(event);\n        break;\n    }\n  }\n\n  async _handleUpdate(event) {\n    const { listenerId: id } = event;\n\n    // abort if no longer exists js side\n    if (!this._pending[id]) {\n      return this._remove(id);\n    }\n\n    const { meta, transaction } = this._pending[id];\n    const { updateFunction, reject } = meta;\n\n    // clear any saved state from previous transaction runs\n    transaction._prepare();\n\n    let finalError;\n    let updateFailed;\n    let pendingResult;\n\n    try {\n      const possiblePromise = updateFunction(transaction);\n\n      // validate user has returned a promise in their update function\n      if (!possiblePromise || !possiblePromise.then) {\n        throw new Error(\n          \"firebase.firestore().runTransaction(*) 'updateFunction' must return a Promise.\",\n        );\n      }\n\n      pendingResult = await possiblePromise;\n    } catch (exception) {\n      // exception can still be falsey if user `Promise.reject();` 's with no args\n      // so we track the exception with a updateFailed boolean to ensure no fall-through\n      updateFailed = true;\n      finalError = exception;\n    }\n\n    // reject the final promise and remove from native\n    // update is failed when either the users updateFunction\n    // throws an error or rejects a promise\n    if (updateFailed || finalError) {\n      return reject(finalError);\n    }\n\n    // capture the resolved result as we'll need this\n    // to resolve the runTransaction() promise when\n    // native emits that the transaction is final\n    transaction._pendingResult = pendingResult;\n\n    // send the buffered update/set/delete commands for native to process\n    return this._firestore.native.transactionApplyBuffer(id, transaction._commandBuffer);\n  }\n\n  /**\n   * Reject the promise with a native error event\n   *\n   * @param event\n   * @private\n   */\n  _handleError(event) {\n    const { listenerId: id, body } = event;\n    const { error } = body;\n\n    if (!this._pending[id]) {\n      return;\n    }\n\n    const { meta } = this._pending[id];\n\n    if (meta && error) {\n      const errorAndStack = NativeError.fromEvent(error, 'firestore', meta.stack);\n      meta.reject(errorAndStack);\n    }\n  }\n\n  /**\n   * Once the transaction has completed on native, resolve the promise with any\n   * pending results\n   *\n   * @param event\n   * @private\n   */\n  _handleComplete(event) {\n    const { listenerId: id } = event;\n\n    if (!this._pending[id]) {\n      return;\n    }\n\n    const { meta, transaction } = this._pending[id];\n    if (meta) {\n      meta.resolve(transaction._pendingResult);\n    }\n  }\n\n  /**\n   * Internally adds a transaction execution function to the queue\n   *\n   * @param updateFunction\n   * @returns {Promise<any>}\n   * @private\n   */\n  _add(updateFunction) {\n    const id = generateTransactionId();\n\n    const meta = {\n      id,\n      updateFunction,\n      stack: new Error().stack.split('\\n').slice(2).join('\\n'),\n    };\n\n    this._pending[id] = {\n      meta,\n      transaction: new FirestoreTransaction(this._firestore, meta),\n    };\n\n    return new Promise((resolve, reject) => {\n      this._firestore.native.transactionBegin(id);\n\n      meta.resolve = result => {\n        this._remove(id);\n        resolve(result);\n      };\n\n      meta.reject = error => {\n        this._remove(id);\n        reject(error);\n      };\n    });\n  }\n\n  /**\n   * Internally removes the transaction once it has resolved\n   * or rejected\n   *\n   * @param id\n   * @private\n   */\n  _remove(id) {\n    this._firestore.native.transactionDispose(id);\n    delete this._pending[id];\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}